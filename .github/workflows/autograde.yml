name: ðŸŒ±ðŸš€ðŸ’Ž Ã‰co-Coding - Tous Niveaux

on:
  push:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"
  pull_request:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"

permissions:
  contents: write

jobs:
  eco-coding:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref_name || 'main' }}
          fetch-depth: 0 # Full history for pushing commits

      # -----------------------------
      # SETUP PYTHON
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # DÃ‰BUTANT TESTS
      # -----------------------------
      - name: Tests DÃ©butant
        run: |
          echo "ðŸŒ± Running DÃ©butant tests..."
          python -m Exercices_Debutant.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # AVANCÃ‰ TESTS
      # -----------------------------
      - name: Tests AvancÃ©
        run: |
          echo "ðŸš€ Running AvancÃ© tests..."
          python -m Exercices_Avance.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # EXPERT TESTS
      # -----------------------------
      - name: Tests Expert
        run: |
          echo "ðŸ’Ž Running Expert tests..."
          python -m Exercices_Expert.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # COMMIT REPORTS (FORCE)
      # -----------------------------
      - name: Commit all reports
        if: always()
        run: |
          echo "ðŸ“¦ Preparing to commit reports..."

          git config --local user.email "action@github.com"
          git config --local user.name "Bot Ã‰co-Coding"

          # Ensure we are on the correct branch
          CURRENT_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-main}}"
          git fetch origin
          git checkout $CURRENT_BRANCH
          git reset --hard origin/$CURRENT_BRANCH

          # Force add and commit report files (overwrite every time)
          git add ECO_REPORT_DEBUTANT.md ECO_REPORT_AVANCE.md ECO_REPORT_EXPERT.md
          git commit -m "ðŸŒ±ðŸš€ðŸ’Ž Mise Ã  jour rapports Ã‰co-Coding [skip ci]" --allow-empty
          git push origin $CURRENT_BRANCH
