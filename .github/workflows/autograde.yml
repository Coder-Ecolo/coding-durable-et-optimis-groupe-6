name: ðŸŒ±ðŸš€ðŸ’Ž Ã‰co-Coding - Tous Niveaux

on:
  push:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"
  pull_request:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"

permissions:
  contents: write

jobs:
  eco-coding:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Correct branch/ref for both push and PR events
          ref: ${{ github.head_ref || github.ref_name || 'main' }}
          fetch-depth: 0 # full history for pushing commits

      # -----------------------------
      # SETUP PYTHON
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # DÃ‰BUTANT TESTS
      # -----------------------------
      - name: Tests DÃ©butant
        run: |
          echo "ðŸŒ± Running DÃ©butant tests..."
          python -m Exercices_Debutant.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # AVANCÃ‰ TESTS
      # -----------------------------
      - name: Tests AvancÃ©
        run: |
          echo "ðŸš€ Running AvancÃ© tests..."
          python -m Exercices_Avance.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # EXPERT TESTS
      # -----------------------------
      - name: Tests Expert
        run: |
          echo "ðŸ’Ž Running Expert tests..."
          python -m Exercices_Expert.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # COMMIT REPORTS
      # -----------------------------
      - name: Commit all reports
        if: always()
        run: |
          echo "ðŸ“¦ Preparing to commit reports..."

          git config --local user.email "action@github.com"
          git config --local user.name "Bot Ã‰co-Coding"

          # Ensure we are synced with remote to avoid conflicts
          git fetch origin
          CURRENT_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-main}}"
          git reset --hard origin/$CURRENT_BRANCH

          # Add report files if they exist
          [ -f ECO_REPORT_DEBUTANT.md ] && git add ECO_REPORT_DEBUTANT.md
          [ -f ECO_REPORT_AVANCE.md ] && git add ECO_REPORT_AVANCE.md
          [ -f ECO_REPORT_EXPERT.md ] && git add ECO_REPORT_EXPERT.md

          # Commit only if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "ðŸŒ±ðŸš€ðŸ’Ž Mise Ã  jour rapports Ã‰co-Coding [skip ci]"
            git push origin $CURRENT_BRANCH
          else
            echo "âœ… No report changes to commit"
          fi
